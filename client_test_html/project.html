<!DOCTYPE html>

<html>

<head>
    <meta charset="UTF-8"/>
    <meta name ="viewport" content="width=device-width, initial-scale=1.0">

    <title>Work-In-Progress | Profile</title>

    <link rel="stylesheet" href="./css/styles.css">
    <link rel="stylesheet" href="./css/project-styles.css">
    <link rel="stylesheet" href="./css/index-styles.css">
    <link rel="stylesheet" href="./css/footer.css">
    <link rel="stylesheet" href="./css/header.css">
</head>

<body>
    <div class="page-container">
        <header>
            <div id="brand-container">
                <a href="/"><img src="http://cdn4.iconfinder.com/data/icons/socialmediaicons_v120/48/google.png" alt="Logo"></a>
                <h3>Work in Progress</h3>
            </div>
            <div id="header-menu">
                <ul>
                    <li><a href="./landing.html">Home</a></li>
                    <li><a href="./index.html">Browse</a></li>
                    <li><a href="./profile.html">Profile</a></li>
                    <li><a href="./post.html">Post</a></li>
                </ul>
            </div>
        </header>
        <div id="content">
            <div id="page-contents">
                <div id="project-display">
                    <input id="project-title">
                    <input id="project-description">
                    <input id="project-tags-list">
                </div>
                <div id="common-action-buttons" class="hidden">
                    <input type="button" onclick="joinProject()" value="Join">
                    <input type="button" onclick="leaveProject()" value="Leave">
                </div>
                <div id="owner-action-buttons" class="hidden">
                    <input type="button" onclick="updateProject()" value="Update">
                    <input type="button" onclick="deleteProject()" value="Close">
                </div>
            </div>
        </div>
        <footer>
            <div id="footer-content">
                <div id="footer-CTA">
                    <h2>Explore</h2>
                    <ul>
                       <a href=""><li>Signup</li></a>
                       <a href=""><li>Signin</li></a>
                       <a href=""><li>Profile</li></a>
                    </ul>
                </div>
                <div id="footer-main">
                    <h2>Overfiew</h2>
                    <ul>
                        <a href=""><li>About</li></a>
                        <a href=""><li>Contact</li></a>
                    </ul>
                </div>
                <div id="footer-site-info">
                    <h2>Explore</h2>
                    <ul>
                       <a href=""><li>Terms of Use</li></a>
                       <a href=""><li>Privacy Policy</li></a>
                    </ul>
                </div>
            </div>
            <p id="footer-copyright">Â© 2021 <a href="">Mark Keeble</a></p>
        </footer>
    </div>
    <script>
        let loggedInId;
        let projectId;
        function checkUser() {
            // Retrieve the object from storage
            var retrievedObject = localStorage.getItem('user');

            if (retrievedObject != null && retrievedObject != undefined) {
                const json = JSON.parse(retrievedObject);
                loggedInId = json.id;

                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('id');

                if (projectId != null && projectId != undefined) {
                    getProject();

                    // Enable action buttons
                    document.getElementById("common-action-buttons").classList.remove("hidden");
                    document.getElementById("common-action-buttons").classList.add("visible");

                    checkIfOwner();
                }
            }
        }
        checkUser();

        function checkIfOwner() {
            const url = "http://markkeeble.com/Work-in-Progress/API/v1/profile/" + loggedInId + "/projects/" + projectId;
            const http = new XMLHttpRequest();
            http.open("GET", url, true);
            http.onreadystatechange = function () { 
                if (http.readyState == 4 && http.status == 200) {
                    let res = JSON.parse(http.responseText.toLocaleLowerCase());
                    if (res === true) {
                        document.getElementById("owner-action-buttons").classList.remove("hidden");
                        document.getElementById("owner-action-buttons").classList.add("visible");
                    }
                }
            }
            http.send();
        }

        function joinProject() {
            const url = "http://markkeeble.com/Work-in-Progress/API/v1/profile/" + loggedInId + "/" + projectId;
            const http = new XMLHttpRequest();
            http.open("POST", url, true);
            http.onreadystatechange = function () { 
                if (http.readyState == 4 && http.status == 200) {
                    console.log(http.responseText);
                }
            }
            http.send();
        }

        function getProject() {

            if (projectId != null && projectId != undefined) {
                getProjectId(projectId);
            }
        }

        function getProjectId(id) {
            const url = "http://markkeeble.com/Work-in-Progress/API/v1/projects/" + id;
            const http = new XMLHttpRequest();
            http.open("GET", url, true);
            http.onreadystatechange = function () { 
                if (http.readyState == 4 && http.status == 200) {
                    setProjectInformation(http.responseText);
                }
            }
            http.send();
        }

        function setProjectInformation(data) {
            let json = JSON.parse(data)[0];
            setProjectPageFields(json);
        }

        function setProjectPageFields(json) {
            if (json == undefined) 
                return;
            document.getElementById("project-title").value = json.title;
            document.getElementById("project-description").value = json.description;
            document.getElementById("project-tags-list").value = json.tag_list;
        }

        function leaveProject() {
            const url = "http://markkeeble.com/Work-in-Progress/API/v1/profile/" + loggedInId + "/projects/" + projectId + "/leave";
            const http = new XMLHttpRequest();
            http.open("DELETE", url, true);
            http.onreadystatechange = function () { 
                if (http.readyState == 4 && http.status == 200) {
                    console.log(http.responseText);
                }
            }
            http.send();
        }

        function deleteProject() {
            const url = "http://markkeeble.com/Work-in-Progress/API/v1/profile/" + loggedInId + "/projects/" + projectId + "/delete";
            const http = new XMLHttpRequest();
            http.open("DELETE", url, true);
            http.onreadystatechange = function () { 
                if (http.readyState == 4 && http.status == 200) {
                    console.log(http.responseText);
                }
            }
            http.send();
        }

        function updateProject() {
            const title = document.getElementById("project-title").value;
            const description = document.getElementById("project-description").value;
            const tagList = document.getElementById("project-tags-list").value;

            const url = "http://markkeeble.com/Work-in-Progress/API/v1/projects/" + projectId;
            const data = JSON.stringify({ title: title, description: description, tagList: tagList });
            const http = new XMLHttpRequest();
            http.open("PUT", url, true);
            http.setRequestHeader("Content-type", "application/json");
            http.onreadystatechange = function () { 
                if (http.readyState == 4 && http.status == 200) {
                    console.log(http.responseText);
                }
            }
            http.send(data);
        }
    </script>
</body>

</html>